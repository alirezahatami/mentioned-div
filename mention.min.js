/*
 * Mentioned Div
 * Written by: Alireza Hatami
 *
 * Using jquery.js
 *
 * License: MIT License - http://www.opensource.org/licenses/mit-license.php
 */

(function(e){e.fn.mention=function(t){function r(e){e.focus();if(typeof window.getSelection!="undefined"&&typeof document.createRange!="undefined"){var t=document.createRange();t.selectNodeContents(e);t.collapse(false);var n=window.getSelection();n.removeAllRanges();n.addRange(t)}else if(typeof document.body.createTextRange!="undefined"){var r=document.body.createTextRange();r.moveToElementText(e);r.collapse(false);r.select()}}function i(t,n){return e.ajax({type:"POST",url:t,data:{data:JSON.stringify(n)}})}function y(e){a.html(e).show();l.hide().remove()}var n={placeholder:"Type the name of someone or something...",callback_file:"a_php_file.php"};t=e.extend({},n,t);var s=/@/ig;var o=/@(\w.+)/ig;var u="display";var a="";var f="msg";var l="";var c="";var h="mentioned";var p="add_mention";var d=t.placeholder;var v="";var m=false;var g="";e(this).on("keyup",function(n){c=e(this);a=e(this).parent().children("#"+u);l=e(this).parent().children("#"+f);if(!a.length)e('<div id="'+u+'"></div>').insertAfter(e(this)).hide();if(!l.length)e('<div id="'+f+'"></div>').insertAfter(e(this)).hide();if(e(this).html().length==0){a.hide().remove();l.hide().remove()}var r=c.text();var h=r.match(s);var d=r.match(o);a.children("."+p).each(function(){var t=e(this).html();if(d=="@"+t.slice("0",v.length).toLowerCase())m=true;else m=false});if(h.length>0){l.html(t.placeholder).show();v=new Text(d);if(d.length>0&&!m){var g=[{"do":"search"},{term:d}];e.when(i(t.callback_file,g)).done(function(e){y(e)})}}return false});e(document).on("click","."+p,function(){var t=e(this).attr("title");var n=e(this).attr("uid");var i=c.html();var s=i.replace(o," ");c.html(s);var u="<a class='"+h+"' contenteditable='false' href='#'>"+t+"</a>&nbsp;";c.append(u);a.hide().remove();l.hide().remove();m=false;g="";var f=c.attr("id");r(document.getElementById(f))})}})(jQuery)